
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Dashboard Overview</title>
    <style>
      /* ================== RESET & BASE ================== */

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f5f3ff 0%, #ddd6fe 100%);
        min-height: 100vh;
        padding: 20px;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
         
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        backdrop-filter: blur(10px);
        min-height: 95vh;
      }

      /* ================== HEADER ================== */
      .header {
        background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
        color: #fff;
        padding: 20px;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        opacity: 0.3;
      }

      .header-content {
        position: relative;
        z-index: 1;
        display: flex;
        /* flex-direction: column; */
        align-items: center;
        justify-content: space-between;
        gap: 15px;
        width: 100%;
      }

      .welcome-text {
        text-align: center;
      }

      @keyframes textGlow {
        from {
          text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        to {
          text-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
        }
      }

      .welcome-text h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        animation: textGlow 2s ease-in-out infinite alternate;
        background: linear-gradient(to right, #fff, #e0e7ff);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      .user-info {
        text-align: center;
        animation: fadeIn 1s ease-out 0.5s both;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      .user-info p {
        margin: 0;
        font-size: 14px;
        color: #e0e7ff;
      }

      .header-actions {
        display: flex;
        justify-content: center;
        order: 3;
        /* width: 100% */
      }

      .logout-button {
        padding: 10px 20px;
        background: #e63946;
        color: #fff;
        border: 0;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        width: 100%;
        max-width: 120px;
      }

      .logout-button:hover {
        background: #d62828;
      }

      .logout-button:active {
        background: #b71c1c;
      }

      /* ================== MAIN ================== */
      .main-content {
        padding: 20px;
        position: relative;
      }

      /* ======== DATE FILTER (in header band) ======== */
      .content-header {
        width: auto;
      }

      .date-section {
        display: flex;
      }

      .date-range-filter {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 12px 18px;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
        transition: all 0.25s ease;
        animation: subtleGlow 6s ease-in-out infinite;
        max-width: 280px;
      }

      @keyframes subtleGlow {
        0% {
          box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
        }

        50% {
          box-shadow: 0 6px 20px rgba(59, 130, 246, 0.25);
        }

        100% {
          box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
        }
      }

      .date-range-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25);
      }

      .date-range-inputs {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }

      .date-range-input {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .date-range-input label {
        font-size: 11px;
        color: #1e40af;
        font-weight: 600;
        text-align: center;
      }

      .date-range-input input {
        width: 100%;
        border: 0;
        background: transparent;
        color: #1e40af;
        font-weight: 700;
        font-size: 13px;
        text-align: center;
        cursor: pointer;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 6px;
        border-bottom: 1px solid #dbeafe;
      }

      .date-range-input input:focus {
        outline: none;
        border-bottom-color: #3b82f6;
      }

      .date-range-input input::-webkit-calendar-picker-indicator {
        cursor: pointer;
        color: #1e40af;
        opacity: 0.7;
      }

      .date-range-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .date-range-btn {
        padding: 6px 12px;
        border: 0;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
        max-width: 120px;
      }

      .date-range-btn.apply {
        background: #3b82f6;
        color: #fff;
      }

      .date-range-btn.clear {
        background: #e2e8f0;
        color: #1e40af;
        border: 1px solid #3b82f6;
      }

      .date-range-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      /* ======== CONTROLS ROW (Search (stacked) + Add button centered) ======== */
      .controls-section {
        /* grid lets us stack the two search bars and keep the +New order button centered */
        display: grid;
        grid-template-columns: auto auto;
        /* col 1: stacked searches, col 2: button */
        column-gap: 24px;
        align-items: start;
        margin-bottom: 24px;
        position: relative;
        width: 100%;
      }

      .search-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .search-box {
        background: #fff;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 14px;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .search-box:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .search-box::placeholder {
        color: #94a3b8;
      }

      .add-order-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      .top-header-demo {
        display: flex;
        width: 100%;
        justify-content: space-between;
        row-gap: 20px;
        align-items: center;
        flex-wrap: wrap;
      }

      .add-order-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #fff;
        border: 0;
        border-radius: 12px;
        padding: 16px 24px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        min-width: 140px;
      }

      .add-order-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
      }

      .add-order-btn:active {
        transform: translateY(0);
      }

      /* ======== TABLE ======== */
      .table-container {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
      }

      .table-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 16px 20px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .table-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
      }

      .table-stats {
        font-size: 14px;
        color: #64748b;
        font-weight: 500;
      }

      .order-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .order-table th {
        background: #f8fafc;
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
        font-size: 13px;
        letter-spacing: 0.5px;
      }

      .order-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
      }

      .order-table tr:hover {
        background: #f9fafb;
      }

      .order-table tr:last-child td {
        border-bottom: 0;
      }

      /* ======== STATUS BADGES ======== */
      .status-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
        min-width: 80px;
        text-align: center;
      }
/* Pending = Blue */
.status-pending {
  background: #dbeafe;   /* light blue */
  color: #1e40af;        /* dark blue */
  border: 1px solid #3b82f6;
}

/* Completed = Green */
.status-completed {
  background: #d1fae5;   /* light green */
  color: #065f46;        /* dark green */
  border: 1px solid #10b981;
}

/* Sold Out = Red/Orange */
.status-cancelled {
  background: #fee2e2;   /* light red */
  color: #b91c1c;        /* dark red */
  border: 1px solid #ef4444;
      }

      /* ======== ACTION BUTTONS ======== */
      .action-btn {
        padding: 6px 12px;
        border: 0;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-right: 4px;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .view-btn {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8); /* gradient blue */
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3); /* soft blue shadow */
  transition: all 0.3s ease;
}

.view-btn:hover {
  background: linear-gradient(135deg, #2563eb, #1e40af);
  transform: translateY(-2px); /* lift effect */
  box-shadow: 0 6px 14px rgba(37, 99, 235, 0.4);
}

.view-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
}

.view-btn:focus {
  outline: none; /* remove black border */
}

     .delete-btn {
  background: linear-gradient(135deg, #ef4444, #b91c1c); /* red gradient */
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3); /* soft red glow */
  transition: all 0.3s ease;
}

.delete-btn:hover {
  background: linear-gradient(135deg, #dc2626, #991b1b);
  transform: translateY(-2px); /* lift effect */
  box-shadow: 0 6px 14px rgba(220, 38, 38, 0.4);
}

.delete-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(220, 38, 38, 0.3);
}

.delete-btn:focus {
  outline: none; /* removes ugly black border */
}
/*  */
.add-products-btn {
  background: linear-gradient(135deg, #10b981, #059669);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
  transition: all 0.3s ease;
}

.add-products-btn:hover {
  background: linear-gradient(135deg, #059669, #047857);
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(5, 150, 105, 0.4);
}

.add-products-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(5, 150, 105, 0.3);
}

.add-products-btn:focus {
  outline: none;
}


      /* ======== MODAL ======== */
      .modal {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        scrollbar-width: none;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }

      .modal-content {
        background: #fff;
        padding: 0;
        border-radius: 12px;
        width: 100%;
        min-height: 100%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
        color: #fff;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
      }

      .close-modal {
        background: 0;
        border: 0;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 3px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s ease;
      }

      .close-modal:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .modal-footer {
        background: #f8fafc;
        padding: 16px 20px;
        border-radius: 0 0 12px 12px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        border-top: 1px solid #e2e8f0;
      }

      /* ======== ORDER DETAILS ======== */
      .order-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 24px;
      }

      .detail-item {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 12px 18px;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
      }

      .detail-label {
        font-size: 12px;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .detail-value {
        font-size: 14px;
        color: #1e293b;
        font-weight: 500;
      }

      /* ======== ORDER ITEMS TABLE ======== */
  /* ======== FIXED MODAL TABLE ALIGNMENT ======== */

.items-table {
  width: 100%;
  table-layout: fixed; /* Use fixed for consistent columns */
  border-collapse: collapse;
}

.items-table th {
  background: #014ac0;
  padding: 12px 15px;
  text-align: left;
  font-weight: 600;
  color: #f3f4f6;
  font-size: 13px;
}

.items-table td {
  padding: 12px 15px;
  border-bottom: 1px solid #f3f4f6;
  vertical-align: middle;
}

/* Column widths - balanced spacing */
.items-table th:nth-child(1),
.items-table td:nth-child(1) { /* # */
  width: 50px;
  text-align: center;
}

.items-table th:nth-child(2),
.items-table td:nth-child(2) { /* Product */
  width: 200px; /* Reduced from 250px */
  text-align: left;
  padding-left: 20px;
}

.items-table th:nth-child(3),
.items-table td:nth-child(3) { /* Price */
  width: 100px;
  text-align: right;
  padding-right: 20px;
}

.items-table th:nth-child(4),
.items-table td:nth-child(4) { /* Quantity */
  width: 140px;
  text-align: center;
}

.items-table th:nth-child(5),
.items-table td:nth-child(5) { /* Total */
  width: 100px;
  text-align: right;
  padding-right: 20px;
}

.items-table th:nth-child(6),
.items-table td:nth-child(6) { /* Action */
  width: 80px;
  text-align: center;
}

/* Quantity controls */
.quantity-control {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  direction: ltr;
}

.quantity-btn {
  width: 28px;
  height: 28px;
  border: 1px solid #d1d5db;
  background: #fff;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: 700;
  padding: 0;
}

.quantity-value {
  min-width: 40px;
  text-align: center;
  font-weight: 700;
  direction: ltr;
}

/* Remove all the conflicting duplicate styles below this line */



      /* ======== TOTALS SECTION ======== */
      .totals-section {
        background: #f8fafc;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
      }

      .total-item {
        text-align: center;
      }

      .total-label {
        font-size: 12px;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .total-value {
        font-size: 18px;
        font-weight: 700;
        color: #1e293b;
      }

      /* ======== SUCCESS MESSAGE ======== */
      .success-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: #fff;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        z-index: 1001;
        animation: slideInRight 0.3s ease-out;
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100%);
        }

        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* ======== LOADING ======== */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        color: #64748b;
        font-size: 14px;
      }

      .loading::after {
        content: "";
        width: 20px;
        height: 20px;
        border: 2px solid #e2e8f0;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .newOrderDiv {
        flex: 1;
        display: flex;
        height: 20vh;
        align-items: end;
        justify-content: center;
      }

      .newOrderDiv1 {
        display: none;
      }

      /* ======== RESPONSIVE ======== */
      @media (max-width: 1000px) {
        .table-container {
          overflow-x: auto;
        }
      }

      @media (max-width: 850px) {
        .customButton {
          padding: 10px 20px;
          font-size: 12px;
        }

        .search-controls {
          width: 100%;
          padding: 0 20px;
        }
        .search-controls input {
          width: 100%;
        }

        .responsive {
          flex-direction: column-reverse;
        }

        .newOrderDiv {
          display: none;
        }

        .newOrderDiv1 {
          display: flex;
          align-items: center;
          justify-content: center;
          margin-top: 20px;
        }
      }

      @media (max-width: 768px) {
        .controls-section {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .add-order-section {
          order: -1;
        }

        .date-range-filter {
          max-width: 100%;
        }

        .order-details {
          grid-template-columns: 1fr;
        }

        .totals-section {
          grid-template-columns: repeat(2, 1fr);
        }
      }
       .add-products-btn:focus {
    outline: none;
  }


/* ======== FIXED RTL ALIGNMENT FOR NUMBERS ======== */

/* Main table: Quantity + Amount */
.order-table td:nth-child(6),
.order-table td:nth-child(7) {
  text-align: right;
  direction: ltr; /* Keep numbers in normal left-to-right order */
}

/* Modal table: Price, Quantity, Total */
.items-table td:nth-child(3),
.items-table td:nth-child(4),
.items-table td:nth-child(5) {
  text-align: right;
  direction: ltr; /* Keep numbers in normal left-to-right order */
}

/* Quantity controls - keep buttons in LTR order */
.quantity-control {
  display: flex;
  align-items: center;
  justify-content: flex-end; /* Align to the right */
  gap: 8px;
  direction: ltr; /* Preserve visual order of the buttons */
}

.quantity-value {
  min-width: 34px;
  text-align: center;
  font-weight: 700;
  direction: ltr; /* Numbers should be LTR */
}

/* Price/Total spans */
.items-table td span,
.order-table td span {
  direction: ltr;
  text-align: right;
  display: inline;
  white-space: nowrap;
}

/* Remove the problematic RTL rules that were causing misalignment */
.items-table td:nth-child(3) span,
.items-table td:nth-child(5) span,
.order-table td:nth-child(6) span,
.order-table td:nth-child(7) span {
  direction: ltr;
  text-align: right;
}
  /* ======== RESPONSIVE ======== */
  @media (max-width: 1000px) {
    .table-container {
      overflow-x: auto;
    }
  }

  /*  */
 /* ======== FIXED DESKTOP ALIGNMENT WITH PROPER SPACING ======== */

/* Ensure proper desktop alignment first */
.items-table {
  width: 100%;
  table-layout: auto; /* Use auto for desktop */
  border-collapse: separate;
  border-spacing: 0;
}

.items-table th {
  background: #014ac0;
  padding: 16px 20px;
  text-align: left;
  font-weight: 600;
  color: #f3f4f6;
  font-size: 14px;
  border: none;
}

.items-table td {
  padding: 14px 20px;
  border-bottom: 1px solid #f3f4f6;
  vertical-align: middle;
  border: none;
}

/* Specific column alignments with proper spacing */


.items-table th:nth-child(3) { /* Price */
  text-align: right;
  padding-left: 25px;
  padding-right: 25px;
  width: 120px;
}

.items-table td:nth-child(3) { /* Price */
  text-align: right;
  direction: ltr;
  font-weight: 600;
  padding-left: 25px;
  padding-right: 25px;
  width: 120px;
  color: #1e40af;
}

.items-table th:nth-child(4) { /* Quantity */
  text-align: center;
  padding-left: 25px;
  padding-right: 25px;
  width: 180px;
}

.items-table td:nth-child(4) { /* Quantity */
  text-align: center;
  direction: ltr;
  padding-left: 25px;
  padding-right: 25px;
  width: 180px;
}

.items-table th:nth-child(5) { /* Total */
  text-align: right;
  padding-left: 25px;
  padding-right: 25px;
  width: 120px;
}

.items-table td:nth-child(5) { /* Total */
  text-align: right;
  direction: ltr;
  font-weight: 700;
  padding-left: 25px;
  padding-right: 25px;
  width: 120px;
  color: #059669;
}

.items-table th:nth-child(6) { /* Action */
  text-align: center;
  padding-left: 25px;
  padding-right: 25px;
  width: 120px;
}

.items-table td:nth-child(6) { /* Action */
  text-align: center;
  padding-left: 25px;
  padding-right: 25px;
  width: 120px;
}

/* Compact quantity controls for desktop */
.quantity-control {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  direction: ltr;
  min-width: 150px;
  padding: 8px 12px;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.quantity-btn {
  width: 32px;
  height: 32px;
  border: 1px solid #d1d5db;
  background: #fff;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: 700;
  font-size: 16px;
  padding: 0;
  transition: all 0.2s ease;
}

.quantity-btn:hover {
  background: #3b82f6;
  color: white;
  border-color: #3b82f6;
}

.quantity-value {
  min-width: 50px;
  text-align: center;
  font-weight: 700;
  direction: ltr;
  padding: 8px 12px;
  background: white;
  border-radius: 4px;
  border: 1px solid #e2e8f0;
  font-size: 15px;
}

/* Hover effects for better UX */
.items-table tr:hover {
  background: #f9fafb;
}

.items-table tr:hover td {
  background: #f9fafb;
}

/* ======== RESPONSIVE FIXES (Only apply on mobile) ======== */

@media (max-width: 768px) {
  .table-container {
    overflow-x: auto;
  }
  
  /* Mobile-specific table styles */
  .items-table {
    table-layout: fixed;
    min-width: 800px; /* Allow horizontal scroll on mobile */
  }
  
  .items-table th,
  .items-table td {
    padding: 12px 15px;
    font-size: 13px;
  }
  
  .items-table th:nth-child(1),
  .items-table td:nth-child(1) {
    width: 60px;
    padding-left: 20px;
    padding-right: 20px;
  }
  
  .items-table th:nth-child(2),
  .items-table td:nth-child(2) {
    width: 200px;
    padding-left: 20px;
    padding-right: 20px;
  }
  
  .items-table th:nth-child(3),
  .items-table td:nth-child(3) {
    width: 100px;
    padding-left: 20px;
    padding-right: 20px;
  }
  
  .items-table th:nth-child(4),
  .items-table td:nth-child(4) {
    width: 150px;
    padding-left: 20px;
    padding-right: 20px;
  }
  
  .items-table th:nth-child(5),
  .items-table td:nth-child(5) {
    width: 100px;
    padding-left: 20px;
    padding-right: 20px;
  }
  
  .items-table th:nth-child(6),
  .items-table td:nth-child(6) {
    width: 100px;
    padding-left: 20px;
    padding-right: 20px;
  }
  
  /* Compact mobile quantity controls */
  .quantity-control {
    min-width: 130px;
    gap: 10px;
    padding: 6px 10px;
  }
  
  .quantity-btn {
    width: 28px;
    height: 28px;
    font-size: 14px;
  }
  
  .quantity-value {
    min-width: 40px;
    font-size: 14px;
    padding: 6px 10px;
  }
}

/* Remove or fix the problematic media queries that are too broad */
@media (max-width: 1000px) {
  /* Only apply overflow, don't change table structure */
  .table-container {
    overflow-x: auto;
  }
}

@media (max-width: 850px) {
  /* Only affect the specific elements that need mobile adjustment */
  .customButton {
    padding: 10px 20px;
    font-size: 12px;
  }

  .search-controls {
    width: 100%;
    padding: 0 20px;
  }
  
  .search-controls input {
    width: 100%;
  }

  .responsive {
    flex-direction: column-reverse;
  }

  .newOrderDiv {
    display: none;
  }

  .newOrderDiv1 {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 20px;
  }
  
  /* Don't let mobile styles affect the modal table alignment */
  .items-table {
    min-width: 800px; /* Force horizontal scroll instead of breaking layout */
  }
}

/* ======== MODAL SCROLLABLE FOR DESKTOP ======== */
.modal {
  display: none;
  position: fixed; /* Changed from absolute to fixed */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow-y: auto; /* Enable vertical scrolling */
  scrollbar-width: thin; /* For Firefox */
  z-index: 1000;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
}

.modal-content {
  background: #fff;
  padding: 0;
  border-radius: 12px;
  width: 100%; /* Increased from 95% */
  max-width: 1400px; /* Increased from 1200px */
  min-height: auto;
  margin: 40px auto;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  animation: modalSlideIn 0.3s ease-out;
  max-height: 90vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.modal-body {
  flex: 1;
  overflow-y: auto; /* Enable scrolling for body content */
  padding: 20px;
  max-height: calc(90vh - 140px); /* Account for header/footer height */
}

/* Custom scrollbar styling for webkit browsers */
.modal-body::-webkit-scrollbar {
  width: 8px;
}

.modal-body::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Ensure the order items table is scrollable if needed */
.modal-body .order-details {
  max-height: none; /* Remove any height restrictions */
}

.modal-body .items-table-container {
  max-height: 400px; /* Limit table height */
  overflow-y: auto;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
}

/* Update the order items section HTML structure */
.modal-body .items-table {
  margin-bottom: 0; /* Remove bottom margin since container handles it */
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .modal-content {
    width: 98%;
    margin: 20px auto;
    max-height: 95vh;
  }
  
  .modal-body {
    max-height: calc(95vh - 120px);
    padding: 15px;
  }
  
  .modal-body .items-table-container {
    max-height: 300px;
  }
}

@media (max-width: 480px) {
  .modal-content {
    width: 100%;
    margin: 10px auto;
    border-radius: 0;
    max-height: 100vh;
  }
  
  .modal-body {
    max-height: calc(100vh - 100px);
    padding: 10px;
  }
}
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-content" style="display: flex">
          <div class="user-info" style="flex: 1">
            <p style="text-align: start" id="loginInfo"></p>
          </div>
          <div class="welcome-text" style="flex: 1">
            <h2 style="text-align: center">Dashboard Overview</h2>
          </div>
          <div
            class="header-actions"
            style="flex: 1; display: flex; justify-content: end"
          >
            <button class="logout-button" onclick="logout()">Logout</button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="top-header-demo">
          <div style="width: 100%">
            <div
              class="responsive"
              style="
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 20px;
              "
            >
              <div class="search-controls" style="flex: 1">
               <input
  type="text"
  class="search-box"
  id="searchByNameInput"
  placeholder="Search by Customer Name or Phone Number"
/>
<input
  type="text"
  class="search-box"
  id="searchByIdInput"
  placeholder="Search by Entry Number or Order ID"
  style="min-width: 250px"
/>

              </div>

              <div class="newOrderDiv">
                <button
                  class="customButton"
                  style="
                    background: blue;
                    border-radius: 10px;
                    color: #eee;
                    padding: 15px 50px;
                    border: none;
                    outline: none;
                    cursor: pointer;
                    font-weight: 600;
                    letter-spacing: 0.5px;
                  "
                  onclick="redirectToAddProducts()"
                >
                  + New Order
                </button>
              </div>

              <div
                class="content-header"
                style="flex: 1; display: flex; justify-content: end"
              >
                <div>
                  <form
                    style="
                      background: white;
                      border: 1px solid #eee;
                      padding: 10px;
                      border-radius: 10px;
                    "
                    id="dateRangeForm"
                  >
                    <div class="date-range-inputs">
                      <div class="date-range-input">
                        <label for="fromDate">From Date</label>
                        <input
                          type="date"
                          id="fromDate"
                          name="fromDate"
                          autocomplete="off"
                        />
                      </div>
                      <div class="date-range-input">
                        <label for="toDate">To Date</label>
                        <input
                          type="date"
                          id="toDate"
                          name="toDate"
                          autocomplete="off"
                        />
                      </div>
                    </div>
                    <div class="date-range-actions">
                      <button type="submit" class="date-range-btn apply">
                        Apply
                      </button>
                      <button
                        type="button"
                        class="date-range-btn clear"
                        id="clearDateBtn"
                      >
                        Clear
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="newOrderDiv1">
              <button
                class="customButton"
                style="
                  background: blue;
                  border-radius: 10px;
                  color: #eee;
                  padding: 15px 50px;
                  border: none;
                  outline: none;
                  cursor: pointer;
                  font-weight: 600;
                  letter-spacing: 0.5px;
                "
                onclick="redirectToAddProducts()"
              >
                + New Order
              </button>
            </div>
          </div>

          <!-- Table Container -->
          <div class="table-container" style="margin-top: 20px; width: 100%">
            <table class="order-table">
              <thead>
                <tr style="height: 6vh">
                  <th
                    style="
                      background: linear-gradient(
                        135deg,
                        #1e40af 0%,
                        #2563eb 100%
                      );
                      color: #eee;
                    "
                  >
                    Order ID
                  </th>
                  <th
                    style="
                      background: linear-gradient(
                        135deg,
                        #1e40af 0%,
                        #2563eb 100%
                      );
                      color: #eee;
                    "
                  >
                    Order Date
                  </th>
                  <th
                    style="
                      background: linear-gradient(
                        135deg,
                        #1e40af 0%,
                        #2563eb 100%
                      );
                      color: #eee;
                    "
                  >
                    Created By
                  </th>
                  <th
                    style="
                      background: linear-gradient(
                        135deg,
                        #1e40af 0%,
                        #2563eb 100%
                      );
                      color: #eee;
                    "
                  >
                    Customer
                  </th>
                  <th
                    style="
                      background: linear-gradient(
                        135deg,
                        #1e40af 0%,
                        #2563eb 100%
                      );
                      color: #eee;
                    "
                  >
                    Phone Number
                  </th>
                  <th
                    style="
                      background: linear-gradient(
                        135deg,
                        #1e40af 0%,
                        #2563eb 100%
                      );
                      color: #eee;
                    "
                  >
                    Total Quantity
                  </th>
                  <th
                    style="
                      background: linear-gradient(
                        135deg,
                        #1e40af 0%,
                        #2563eb 100%
                      );
                      color: #eee;
                    "
                  >
                    Amount
                  </th>
                  <th
                    style="
                      background: linear-gradient(
                        135deg,
                        #1e40af 0%,
                        #2563eb 100%
                      );
                      color: #eee;
                    "
                  >
                    Edit
                  </th>
                  <th
                    style="
                      background: linear-gradient(
                        135deg,
                        #1e40af 0%,
                        #2563eb 100%
                      );
                      color: #eee;
                    "
                  >
                    Status
                  </th>
                  <th
                    style="
                      background: linear-gradient(
                        135deg,
                        #1e40af 0%,
                        #2563eb 100%
                      );
                      color: #eee;
                    "
                  >
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody id="orderTableBody">
                <tr>
                  <td colspan="9" class="loading">Loading orders...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Order Details Modal -->
      <div id="orderHistoryModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Order Details</h3>
            <button class="close-modal">&times;</button>
          </div>
          <div class="modal-body">
            <!-- Order Details -->
            <div class="order-details">
  <div class="detail-item">
    <div class="detail-label">Order ID</div>
    <div class="detail-value" id="modalOrderId">-</div>
  </div>

  <div class="detail-item">
    <div class="detail-label">Created By</div>
    <div class="detail-value" id="modalCreatedBy">-</div>
  </div>

  <div class="detail-item">
    <div class="detail-label">Customer Name</div>
    <div class="detail-value" id="modalCustomerName">-</div>
  </div>

  <div class="detail-item">
    <div class="detail-label">Phone</div>
    <div class="detail-value" id="modalCustomerPhone">-</div>
  </div>

  <div class="detail-item">
    <div class="detail-label">Address</div>
    <div class="detail-value" id="modalPlace">-</div>
  </div>

  <div class="detail-item">
    <div class="detail-label">Created On</div>
    <div class="detail-value" id="modalCreatedOn">-</div>
  </div>
</div>

            <!-- Order Items -->
            <h4 style="margin-bottom: 16px; color: #1e293b; padding-left: 10px;">Order Items</h4>

            <div style="width: 100%; overflow-x: auto;">
              <table class="items-table">
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="modalOrderItemsList">

                </tbody>
              </table>
            </div>

            <!-- Totals -->
            <div class="totals-section">
              <div class="total-item">
                <div class="total-label">Total Quantity</div>
                <div class="total-value" id="modalItemTotal">0</div>
              </div>
              <div class="total-item">
                <div class="total-label">Quantity</div>
                <div class="total-value" id="modalItemCount">0</div>
              </div>
              <div class="total-item">
                <div class="total-label">Bill Total</div>
                <div class="total-value" id="modalBillTotal">‚Çπ0</div>
              </div>
              <div class="total-item">
                <div class="total-label">Grand Total</div>
                <div class="total-value" id="modalGrandTotal">‚Çπ0</div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="action-btn add-products-btn" id="addProductsFromModal">
  ‚ûï Add Products
</button>

            <!-- <button class="action-btn view-btn" id="updateOrderBtn">Update Order</button> -->
          </div>
        </div>
      </div>
    </div>

    <!-- Lightweight product picker overlay (created once, reused) -->
    <div id="productPickerOverlay" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 1100; align-items: center; justify-content: center;">
      <div style="background:#fff; width: 96%; max-width: 520px; max-height: 80vh; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,.25); display:flex; flex-direction:column;">
        <div style="padding:12px 16px; background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color:#fff; display:flex; align-items:center; justify-content:space-between;">
          <strong>Select a product</strong>
          <button id="closeProductPickerBtn" style="background:transparent; border:0; color:#fff; font-size:20px; cursor:pointer">√ó</button>
        </div>
        <div style="padding:10px 12px; border-bottom:1px solid #e5e7eb">
          <input id="productPickerSearch" type="text" placeholder="Search product name or code..." style="width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:8px; font-size:14px;"/>
        </div>
        <div id="productPickerList" style="overflow:auto; padding:6px 0;">
          <div style="padding:14px; color:#64748b;">Loading products...</div>
        </div>
      </div>
    </div>

    <script>
  // Global variables
  let orderData = [];
  let currentOrderDetails = null;
  let currentFilters = {
    fromDate: "",
    toDate: "",
    status: "",
    page: 1,
  };

  // User data (you'll need to pass this from Django)
  const userData = {
    user_id: localStorage.getItem("user_id"),
    client_id: localStorage.getItem("client_id"),
  };

  // API Base URL (set this if your API is hosted on another origin)
  const API_BASE = "";

  // Utility functions
  function formatPrice(price) {
    if (price == null || price === "") return "‚Çπ0.00";
    return "‚Çπ" + Number(price).toFixed(2);
  }

  function formatDate(dateString) {
    if (!dateString) return "-";
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString; // fallback if already formatted
    return date.toLocaleDateString("en-GB");
  }

  function showSuccessMessage(message) {
    const successDiv = document.createElement("div");
    successDiv.className = "success-message";
    successDiv.textContent = message;
    document.body.appendChild(successDiv);
    setTimeout(() => successDiv.remove(), 3000);
  }

  function showErrorMessage(message) {
    const errorDiv = document.createElement("div");
    errorDiv.className = "success-message";
    errorDiv.style.background = "#ef4444";
    errorDiv.textContent = message;
    document.body.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 3000);
  }

  // API Functions
  async function fetchOrders(filters = {}) {
    try {
      const params = new URLSearchParams({
        user_id: userData.user_id,
        client_id: userData.client_id,
        page: filters.page || 1,
        per_page: 20,
      });

      if (filters.status) params.append("status", filters.status);

      const response = await fetch(`${API_BASE}/api/orders/get/?${params.toString()}`);
      const data = await response.json();

      if (data.success) {
        return data;
      } else {
        throw new Error(data.error || "Failed to fetch orders");
      }
    } catch (error) {
      console.error("Error fetching orders:", error);
      showErrorMessage("Failed to load orders");
      return { orders: [], pagination: {} };
    }
  }

  async function updateOrderStatus(orderId, newStatus) {
    try {
      const response = await fetch(`${API_BASE}/api/orders/update-status/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          order_id: orderId,
          status: newStatus,
        }),
      });

      const data = await response.json();
      if (data.success) {
        showSuccessMessage("Order status updated successfully");
        loadOrders();
      } else {
        throw new Error(data.error || "Failed to update order status");
      }
    } catch (error) {
      console.error("Error updating order status:", error);
      showErrorMessage("Failed to update order status");
    }
  }

  async function deleteOrder(orderId) {
    if (!confirm("Are you sure you want to delete this order?")) return;

    try {
      const response = await fetch(`${API_BASE}/api/orders/delete/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ order_id: orderId }),
      });

      const data = await response.json();
      if (data.success) {
        showSuccessMessage("Order deleted successfully");

        // 1) update local cache
        orderData = (orderData || []).filter((o) => o.id !== orderId);

        // 2) remove just that row from the DOM
        const row = document.querySelector(`#orderTableBody tr[data-order-id="${orderId}"]`);
        if (row) row.remove();

        // 3) if nothing left after filters, show empty-state row
        const tbody = document.getElementById("orderTableBody");
        if (!tbody.querySelector("tr")) {
          tbody.innerHTML =
            '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #64748b;">No orders found</td></tr>';
        }
      } else {
        throw new Error(data.error || "Failed to delete order");
      }
    } catch (error) {
      console.error("Error deleting order:", error);
      showErrorMessage("Failed to delete order");
    }
  }

  async function deleteOrderItem(itemId) {
    if (!confirm("Are you sure you want to delete this item?")) return;

    try {
      const response = await fetch(`${API_BASE}/api/orders/delete-item/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          item_id: itemId,
        }),
      });

      const data = await response.json();
      if (data.success) {
        showSuccessMessage("Order item deleted successfully");
        // refresh modal and list
        if (currentOrderDetails && currentOrderDetails.id) {
          // re-fetch current order to reflect server state
          await viewOrder(currentOrderDetails.id);
        }
        loadOrders();
      } else {
        throw new Error(data.error || "Failed to delete order item");
      }
    } catch (error) {
      console.error("Error deleting order item:", error);
      showErrorMessage("Failed to delete order item");
    }
  }

  // UI Functions
  function populateTable(orders = []) {
    const tbody = document.getElementById("orderTableBody");

    if (orders.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #64748b;">No orders found</td></tr>';
      return;
    }

    tbody.innerHTML = "";
    orders.forEach((order) => {
      const row = document.createElement("tr");
      row.setAttribute("data-order-id", order.id); // <-- add this
      row.innerHTML = `
        <td>${order.order_number}</td>
        <td>${formatDate(order.created_at)}</td>
        <td>${localStorage.getItem("user_id") || "Guest"}</td>
        <td>${order.customer_name || "-"}</td>
        <td>${order.customer_phone || "-"}</td>
       <td><span>${order.total_quantity || 0}</span></td>
  <td><span>${formatPrice(order.total_amount || 0)}</span></td>

        <td>
          <button class="action-btn view-btn" onclick="viewOrder(${order.id})" title="View Details">Show Items</button>
        </td>
        <td>
          <select onchange="updateOrderStatus(${order.id}, this.value)" class="status-badge status-${order.status}">
            <option value="pending" ${order.status === "pending" ? "selected" : ""}>Pending</option>
            <option value="completed" ${order.status === "completed" ? "selected" : ""}>Completed</option>
            <option value="cancelled" ${order.status === "cancelled" ? "selected" : ""}>Sold Out</option>
          </select>
        </td>
        <td>
          <button class="action-btn delete-btn" onclick="deleteOrder(${order.id})" title="Delete Order">üóëÔ∏è</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  let itemDisplayOrder = new Map(); // To store the initial display order

  async function viewOrder(orderId) {
    try {
      const response = await fetch(
        `${API_BASE}/api/orders/get/?user_id=${userData.user_id}&client_id=${userData.client_id}&order_id=${orderId}`
      );
      const data = await response.json();

      if (!data.success || !Array.isArray(data.orders) || data.orders.length === 0) {
        throw new Error("Order not found");
      }

      // locate the order (defensive)
      const order = data.orders.find((item) => String(item.id) === String(orderId)) || data.orders[0];
      currentOrderDetails = order;

      // Update modal header (safe defaults)
      document.getElementById("modalOrderId").textContent = order.order_number || `#${orderId}`;
      document.getElementById("modalCustomerName").textContent = order.customer_name || "-";
      document.getElementById("modalCustomerPhone").textContent = order.customer_phone || "-";
      document.getElementById("modalPlace").textContent = order.customer_address || "-";
      document.getElementById("modalCreatedBy").textContent = userData.user_id || "-";
      document.getElementById("modalCreatedOn").textContent = formatDate(order.created_at);

      // Try to fetch server customers and match; fallback to manual customer object if no match
      let customerList = [];
      try {
        const customersResp = await fetch("/customers/", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("access_token")}`,
          },
        });
        if (customersResp.ok) {
          customerList = await customersResp.json();
        } else {
          customerList = [];
        }
      } catch (e) {
        console.warn("Failed to fetch customers list:", e);
        customerList = [];
      }

      const matchedCustomer = Array.isArray(customerList)
        ? customerList.find(
            (x) =>
              x.client_id == (localStorage.getItem("client_id") || userData.client_id) &&
              x.name === order.customer_name
          )
        : null;

      if (matchedCustomer) {
        localStorage.setItem("selected_customer", JSON.stringify(matchedCustomer));
      } else {
        // fallback manual customer so order.html edit mode can use it
        const manualCustomer = {
          client_id: localStorage.getItem("client_id") || order.client_id || "",
          name: order.customer_name || "",
          phone: order.customer_phone || "",
          address: order.customer_address || "",
          __manual_from_order: true,
        };
        localStorage.setItem("selected_customer", JSON.stringify(manualCustomer));

        // Also include manual_customers list entry (optional, helpful for dropdowns)
        try {
          const existingManual = JSON.parse(localStorage.getItem("manual_customers") || "[]");
          const already = Array.isArray(existingManual) && existingManual.find((m) => m.name === manualCustomer.name && m.client_id === manualCustomer.client_id);
          if (!already) {
            const updated = Array.isArray(existingManual) ? [...existingManual, manualCustomer] : [manualCustomer];
            localStorage.setItem("manual_customers", JSON.stringify(updated));
          }
        } catch (e) {
          // ignore parse errors
          localStorage.setItem("manual_customers", JSON.stringify([manualCustomer]));
        }
      }

      // Save editing_order and editing_order_cart for the edit flow
      localStorage.setItem("editing_order", JSON.stringify(order));
      const editingCart = (order.items || []).map((it) => ({
        id: it.id,
        product_code: it.product_code || it.sku || it.product_id || "",
        product_name: it.product_name || it.name || "",
        quantity: it.quantity || it.qty || 0,
        unit_price: it.unit_price != null ? it.unit_price : it.price || 0,
        total_price: (it.quantity || it.qty || 0) * (it.unit_price || it.price || 0),
        raw: it,
      }));
      localStorage.setItem("editing_order_cart", JSON.stringify(editingCart));

      // Update items table (stable on-screen order)
      const itemsList = document.getElementById("modalOrderItemsList");
      if (!itemsList) {
        console.warn("modalOrderItemsList element not found");
      } else {
        itemsList.innerHTML = "";

        // Capture the initial display order only once per modal open
        if (itemDisplayOrder.size === 0) {
          (order.items || []).forEach((it, idx) => {
            const key = it.id != null ? String(it.id) : `idx-${idx}`;
            itemDisplayOrder.set(key, idx);
          });
        }

        // Render items using the remembered order so rows don't jump after edits
       const itemsInStableOrder = [...(order.items || [])].sort((a, b) => {
  const aTime = Date.parse(a.created_at || a.added_at || 0) || 0;
  const bTime = Date.parse(b.created_at || b.added_at || 0) || 0;
  if (aTime !== bTime) {
    return bTime - aTime; // newest first
  }
  return (b.id || 0) - (a.id || 0); // fallback by id
});

itemsInStableOrder.forEach((item, index) => {
  const row = document.createElement("tr");
  row.setAttribute("data-item-id", item.id); // handy for future in-place updates

          // we pass 'this' to onclick handlers so increase/decrease can inspect the clicked button
        row.innerHTML = `
  <td>${index + 1}</td>
  <td>${escapeHtml(item.product_name || item.name || "Unknown product")}</td>
  <td><span>${formatPrice(item.unit_price != null ? item.unit_price : item.price || 0)}</span></td>
  <td>
    <div class="quantity-control">
      <button class="quantity-btn negative" onclick="decreaseQuantity(${item.id}, this)" ${((item.quantity || item.qty || 0) <= 1) ? "disabled" : ""}>-</button>
      <span class="quantity-value" title="Click to set quantity" onclick="manualSetQuantity(${item.id}, ${item.quantity || item.qty || 0})">${item.quantity || item.qty || 0}</span>
      <button class="quantity-btn" onclick="increaseQuantity(${item.id}, this)">+</button>
    </div>
  </td>
  <td><span>${formatPrice(item.total_price != null ? item.total_price : ((item.quantity || item.qty || 0) * (item.unit_price || item.price || 0)))}</span></td>
  <td>
    <button class="action-btn delete-btn" onclick="deleteOrderItem(${item.id})" title="Delete Item">üóëÔ∏è</button>
  </td>
`;

          itemsList.appendChild(row);
        });
      }

      // Update totals (defensive fallback)
      document.getElementById("modalItemTotal").textContent = order.item_count != null ? order.item_count : (order.items || []).length;
      document.getElementById("modalItemCount").textContent = order.total_quantity != null ? order.total_quantity : (order.items || []).reduce((s, it) => s + (it.quantity || it.qty || 0), 0);
      document.getElementById("modalBillTotal").textContent = formatPrice(order.total_amount || 0);
      document.getElementById("modalGrandTotal").textContent = formatPrice(order.total_amount || 0);

      // Show modal
      const modalEl = document.getElementById("orderHistoryModal");
      if (modalEl) {
        modalEl.style.display = "block";
      }
    } catch (error) {
      console.error("Error viewing order:", error);
      showErrorMessage("Failed to load order details");
    }
  }

  // Increase / Decrease quantity handlers (receive clicked button as second param)
  function increaseQuantity(itemId, btnEl) {
    try {
      const quantityElement = btnEl.parentElement.querySelector(".quantity-value");
      const currentQuantity = parseInt(quantityElement.textContent || "0", 10);
      updateOrderItem(itemId, currentQuantity + 1, "increase");
    } catch (e) {
      console.error("increaseQuantity error", e);
    }
  }

  function decreaseQuantity(itemId, btnEl) {
    try {
      const quantityElement = btnEl.parentElement.querySelector(".quantity-value");
      const currentQuantity = parseInt(quantityElement.textContent || "0", 10);
      if (currentQuantity > 1) {
        updateOrderItem(itemId, currentQuantity - 1, "decrease");
      }
    } catch (e) {
      console.error("decreaseQuantity error", e);
    }
  }

  // Manual quantity set with inline input (no alert/prompt)
  function manualSetQuantity(itemId, currentQty) {
    try {
      // Find the span for this item and replace with an input temporarily
      const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
      if (!row) return;
      const container = row.querySelector(".quantity-control");
      if (!container) return;
      const valueSpan = container.querySelector(".quantity-value");
      if (!valueSpan) return;

      const input = document.createElement("input");
      input.type = "number";
      input.min = "1";
      input.step = "1";
      input.value = String(currentQty || 1);
      input.style.width = "64px";
      input.style.textAlign = "center";
      input.style.fontWeight = "700";
      input.style.border = "1px solid #d1d5db";
      input.style.borderRadius = "4px";
      input.style.padding = "2px 6px";

      valueSpan.replaceWith(input);
      input.focus();
      input.select();

      const commit = () => {
        const parsed = parseInt(input.value, 10);
        if (!Number.isFinite(parsed) || parsed < 1) {
          showErrorMessage("Please enter a valid number (1 or more)");
          input.focus();
          return;
        }
        updateOrderItem(itemId, parsed, "set");
      };

      const cancel = () => {
        // Re-render via viewOrder so UI goes back to normal
        if (currentOrderDetails && currentOrderDetails.id) {
          viewOrder(currentOrderDetails.id);
        }
      };

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") { e.preventDefault(); commit(); }
        if (e.key === "Escape") { e.preventDefault(); cancel(); }
      });
      input.addEventListener("blur", () => commit());
    } catch (e) {
      console.error("manualSetQuantity error", e);
    }
  }

  function closeModal() {
    const modalEl = document.getElementById("orderHistoryModal");
    if (modalEl) modalEl.style.display = "none";
    currentOrderDetails = null;
    // clear captured display order so next modal open can recapture (prevents stale mapping)
    itemDisplayOrder.clear();
  }

  // Note: updateOrderItem should be implemented to call your API to update an item qty
  async function updateOrderItem(itemId, newQty, action) {
    try {
      // Example payload ‚Äî adapt to your API
      const response = await fetch(`${API_BASE}/api/orders/update-item/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ item_id: itemId, quantity: newQty }),
      });
      const data = await response.json();
      if (data.success) {
        showSuccessMessage("Item quantity updated");
        // refresh modal and table
        if (currentOrderDetails && currentOrderDetails.id) await viewOrder(currentOrderDetails.id);
        loadOrders();
      } else {
        throw new Error(data.error || "Failed to update item");
      }
    } catch (e) {
      console.error("updateOrderItem error", e);
      showErrorMessage("Failed to update item");
    }
  }

  // Filter Functions
  function applyDateFilter() {
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;

    currentFilters.fromDate = fromDate;
    currentFilters.toDate = toDate;
    currentFilters.page = 1;

    // If both set, do between; else let loadOrders decide the right mode
    loadOrders(fromDate && toDate ? "between" : "");
  }

  function clearDateFilter() {
    document.getElementById("fromDate").value = "";
    document.getElementById("toDate").value = "";

    currentFilters.fromDate = "";
    currentFilters.toDate = "";
    currentFilters.page = 1;

    // Show all
    loadOrders("");
  }

  // Search Functions
  function setupSearch() {
    // Search by Order ID / Entry Number
    const searchByIdInput = document.getElementById("searchByIdInput");
    if (searchByIdInput) {
      searchByIdInput.addEventListener("input", function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("#orderTableBody tr");
        rows.forEach((row) => {
          const orderId = row.querySelector("td:first-child")?.textContent.toLowerCase() || "";
          row.style.display = orderId.includes(filter) ? "" : "none";
        });
      });
    }

    // Search by Customer Name OR Phone Number
    const searchByNameInput = document.getElementById("searchByNameInput");
    if (searchByNameInput) {
      searchByNameInput.addEventListener("input", function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("#orderTableBody tr");
        rows.forEach((row) => {
          const customerName = row.querySelector("td:nth-child(4)")?.textContent.toLowerCase() || "";
          const customerPhone = row.querySelector("td:nth-child(5)")?.textContent.toLowerCase() || "";
          row.style.display = (customerName.includes(filter) || customerPhone.includes(filter)) ? "" : "none";
        });
      });
    }
  }

  // Main Functions
  // REPLACE the existing loadOrders function with this version
async function loadOrders(method = "") {
  const data = await fetchOrders(currentFilters);
  const list = Array.isArray(data?.orders) ? data.orders : [];

  // Normalize API date to YYYY-MM-DD once
// replaces split(' ')[0]
const toYMD = (created_at) => {
  if (!created_at) return "";
  return String(created_at).slice(0, 10); // handles "YYYY-MM-DD", "YYYY-MM-DD HH:MM:SS", "YYYY-MM-DDTHH:MM:SSZ"
};


  const from = currentFilters.fromDate || "";
  const to = currentFilters.toDate || "";

  let filtered = list;

  // If both dates empty => show ALL
  if (!from && !to) {
    filtered = list;
  } else if (from && to) {
    // Range filter (inclusive) ‚Äî apply whenever both are provided
    filtered = list.filter((x) => {
      const d = toYMD(x.created_at);
      return d >= from && d <= to;
    });
  } else if (from && !to) {
    // Only From set => exact match day
    filtered = list.filter((x) => toYMD(x.created_at) === from);
  } else if (!from && to) {
    // Only To set => everything up to that day
    filtered = list.filter((x) => toYMD(x.created_at) <= to);
  }

  orderData = filtered;
  populateTable(orderData); // existing renderer
}

  function redirectToAddProducts() {
    window.location.href = "{% url 'orders' %}";
  }

  function logout() {
    if (confirm("Are you sure you want to logout ?")) {
      window.location.href = "{% url 'login' %}";

      localStorage.removeItem("access_token");
      localStorage.removeItem("cartData");
      localStorage.removeItem("client_id");
      localStorage.removeItem("editing_order");
      localStorage.removeItem("manual_customers");
      localStorage.removeItem("selected_customer");
      localStorage.removeItem("user_id");
    }
  }

  // Helper: tiny HTML-escape to avoid injecting raw product names into the DOM
  function escapeHtml(str) {
    if (str == null) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Event Listeners
  document.addEventListener("DOMContentLoaded", function () {
    loadOrders();
    setupSearch();

    // Set today's date as default filter
    const today = new Date().toISOString().split("T")[0];
    const fromEl = document.getElementById("fromDate");
    const toEl = document.getElementById("toDate");
    if (fromEl && toEl) {
     fromEl.value = today;
toEl.value = today;
currentFilters.fromDate = today;
currentFilters.toDate = today;
loadOrders("between");

    }

    const userId = localStorage.getItem("user_id") || "Guest";
    const clientId = localStorage.getItem("client_id") || "CLIENT_001";
    const loginInfoEl = document.getElementById("loginInfo");
    if (loginInfoEl) loginInfoEl.innerText = `ID:${clientId} | USERID: ${userId}`;

    // Date range form handlers
    const dateRangeForm = document.getElementById("dateRangeForm");
    if (dateRangeForm) {
      dateRangeForm.addEventListener("submit", function (e) {
        e.preventDefault();
        applyDateFilter();
      });
    }
    const clearDateBtn = document.getElementById("clearDateBtn");
    if (clearDateBtn) {
      clearDateBtn.addEventListener("click", function () {
        clearDateFilter();
      });
    }

    // Modal close handlers
    const modal = document.getElementById("orderHistoryModal");
    const closeBtn = document.querySelector(".close-modal");
    if (closeBtn) closeBtn.onclick = closeModal;
    window.onclick = (e) => {
      if (e.target === modal) closeModal();
    };
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    // Add Products button inside modal: open inline product picker (no redirect yet)
    const addProductsBtn = document.getElementById("addProductsFromModal");
    if (addProductsBtn) {
      addProductsBtn.addEventListener("click", function () {
        openProductPicker();
      });
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî Product picker implementation ‚Äî‚Äî‚Äî‚Äî‚Äî
    let productPickerAll = [];
    function openProductPicker() {
      const overlay = document.getElementById("productPickerOverlay");
      const listEl = document.getElementById("productPickerList");
      const searchEl = document.getElementById("productPickerSearch");
      if (!overlay || !listEl) return;

      overlay.style.display = "flex";

      // Close wiring
      const closer = document.getElementById("closeProductPickerBtn");
      if (closer) closer.onclick = () => (overlay.style.display = "none");
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.style.display = "none";
      };

      // Fetch once per open
      listEl.innerHTML = '<div style="padding:14px; color:#64748b;">Loading products...</div>';
      fetch("/products/", {
        headers: {
          Authorization: `Bearer ${localStorage.getItem("access_token")}`,
        },
      })
        .then((r) => r.json())
        .then((data) => {
          const results = (data?.results || []).map((p) => ({
            code: p.code,
            name: p.name,
            brand: p.brand,
            unit: p.unit,
            price: p.batch?.salesprice ?? p.batch?.bmrp ?? 0,
          }));
          productPickerAll = results;
          renderPickerList(results);
        })
        .catch(() => {
          listEl.innerHTML = '<div style="padding:14px; color:#ef4444;">Failed to load products</div>';
        });

      // Search filter
      if (searchEl) {
        searchEl.value = "";
        searchEl.oninput = () => {
          const q = searchEl.value.trim().toLowerCase();
          const filtered = !q
            ? productPickerAll
            : productPickerAll.filter((p) =>
                (p.name || "").toLowerCase().includes(q) || (p.code || "").toLowerCase().includes(q)
              );
          renderPickerList(filtered);
        };
      }

      function renderPickerList(items) {
        if (!Array.isArray(items) || items.length === 0) {
          listEl.innerHTML = '<div style="padding:14px; color:#64748b;">No products found</div>';
          return;
        }
        listEl.innerHTML = "";
        items.forEach((p) => {
          const row = document.createElement("div");
          row.style.padding = "10px 14px";
          row.style.borderBottom = "1px solid #eef2f7";
          row.style.cursor = "pointer";
          row.innerHTML = `<div style="font-weight:600;color:#1e293b">${(p.name || "").replace(/</g, "&lt;")}</div>
                           <div style="font-size:12px;color:#64748b">Code: ${(p.code || "").replace(/</g, "&lt;")}${p.brand ? ` ‚Ä¢ ${p.brand}` : ""}${p.unit ? ` ‚Ä¢ ${p.unit}` : ""}</div>`;
          row.onclick = () => selectProductForOrder(p);
          listEl.appendChild(row);
        });
      }
    }

    async function selectProductForOrder(product) {
      const overlay = document.getElementById("productPickerOverlay");
      if (overlay) overlay.style.display = "none";

      // We add the product directly to the cart for the same customer and then
      // immediately "place" the cart so it merges into the existing pending order.
      if (!currentOrderDetails) {
        return;
      }

      try {
        // Always use the customer from the order to avoid creating another order accidentally
        const customer = {
          name: currentOrderDetails.customer_name || "Guest",
          phone: currentOrderDetails.customer_phone || "",
          address: currentOrderDetails.customer_address || "",
        };

        // 1) Add 1 quantity to cart
        const addResp = await fetch("/api/cart/add/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: localStorage.getItem("user_id"),
            client_id: localStorage.getItem("client_id"),
            customer_name: customer.name || "Guest",
            customer_phone: customer.phone || "",
            customer_address: customer.address || "",
            product_code: product.code,
            quantity: 1,
          }),
        });
        const addData = await addResp.json();
        if (!addResp.ok || !addData.success) {
          throw new Error(addData.error || "Failed to add to cart");
        }

        // 2) Merge cart into existing pending order (or create if needed)
        const placeResp = await fetch("/api/orders/place/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: localStorage.getItem("user_id"),
            client_id: localStorage.getItem("client_id"),
            customer_name: customer.name || "Guest",
            customer_phone: customer.phone || "",
            customer_address: customer.address || "",
          }),
        });
        const placeData = await placeResp.json();
        if (!placeResp.ok || !placeData.success) {
          throw new Error(placeData.error || "Failed to update order");
        }

        // 3) Refresh current order details and orders table without navigating
        const newId = placeData.order_id;
        // If server merged into another (or new) order id, switch the modal to that order
        if (newId && String(newId) !== String(currentOrderDetails.id)) {
          await viewOrder(newId);
        } else {
          await viewOrder(currentOrderDetails.id);
        }
        await loadOrders();
        showSuccessMessage("Product added to order");
      } catch (err) {
        console.error(err);
        showErrorMessage(String(err.message || err));
      }
    }
  });

  // In some contexts you might call this from other script blocks ‚Äî keep it safe to call multiple times
  if (typeof window !== "undefined") {
    window.viewOrder = viewOrder;
    window.deleteOrder = deleteOrder;
    window.deleteOrderItem = deleteOrderItem;
    window.updateOrderStatus = updateOrderStatus;
    window.increaseQuantity = increaseQuantity;
    window.decreaseQuantity = decreaseQuantity;
    window.updateOrderItem = updateOrderItem;
  }
</script>

  </body>
</html>
